{"version":3,"file":"useImage-463f1aad.js","sources":["../jsSrc/imagePromiseFactory.js","../jsSrc/useImage.js"],"sourcesContent":["// returns a Promisized version of Image() api\nexport default ({ decode = true, crossOrigin = '', referrerPolicy }) => (src) => {\n    return new Promise((resolve, reject) => {\n        const i = new Image();\n        if (referrerPolicy)\n            i.referrerPolicy = referrerPolicy;\n        if (crossOrigin)\n            i.crossOrigin = crossOrigin;\n        i.onload = () => {\n            decode && i.decode ? i.decode().then(resolve).catch(reject) : resolve();\n        };\n        i.onerror = reject;\n        i.src = src;\n    });\n};\n//# sourceMappingURL=imagePromiseFactory.js.map","import { useState } from 'react';\nimport imagePromiseFactory from './imagePromiseFactory';\nconst removeBlankArrayElements = (a) => a.filter((x) => x);\nconst stringToArray = (x) => (Array.isArray(x) ? x : [x]);\nconst cache = {};\n// sequential map.find for promises\nconst promiseFind = (arr, promiseFactory) => {\n    let done = false;\n    return new Promise((resolve, reject) => {\n        const queueNext = (src) => {\n            return promiseFactory(src).then(() => {\n                done = true;\n                resolve(src);\n            });\n        };\n        arr\n            .reduce((p, src) => {\n            // ensure we aren't done before enquing the next source\n            return p.catch(() => {\n                if (!done)\n                    return queueNext(src);\n            });\n        }, queueNext(arr.shift()))\n            .catch(reject);\n    });\n};\nexport default function useImage({ srcList, imgPromise = imagePromiseFactory({\n    decode: true,\n    referrerPolicy: 'origin',\n}), useSuspense = true, }) {\n    const [, setIsLoading] = useState(true);\n    const sourceList = removeBlankArrayElements(stringToArray(srcList));\n    const sourceKey = sourceList.join('');\n    if (!cache[sourceKey]) {\n        // create promise to loop through sources and try to load one\n        cache[sourceKey] = {\n            promise: promiseFind(sourceList, imgPromise),\n            cache: 'pending',\n            error: null,\n        };\n    }\n    // when promise resolves/reject, update cache & state\n    cache[sourceKey].promise\n        // if a source was found, update cache\n        // when not using suspense, update state to force a rerender\n        .then((src) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'resolved', src };\n        if (!useSuspense)\n            setIsLoading(false);\n    })\n        // if no source was found, or if another error occured, update cache\n        // when not using suspense, update state to force a rerender\n        .catch((error) => {\n        cache[sourceKey] = { ...cache[sourceKey], cache: 'rejected', error };\n        if (!useSuspense)\n            setIsLoading(false);\n    });\n    if (cache[sourceKey].cache === 'resolved') {\n        return { src: cache[sourceKey].src, isLoading: false, error: null };\n    }\n    if (cache[sourceKey].cache === 'rejected') {\n        if (useSuspense)\n            throw cache[sourceKey].error;\n        return { isLoading: false, error: cache[sourceKey].error, src: undefined };\n    }\n    // cache[sourceKey].cache === 'pending')\n    if (useSuspense)\n        throw cache[sourceKey].promise;\n    return { isLoading: true, src: undefined, error: null };\n}\n//# sourceMappingURL=useImage.js.map"],"names":["decode","crossOrigin","referrerPolicy","src","Promise","resolve","reject","i","Image","onload","then","onerror","removeBlankArrayElements","a","filter","x","stringToArray","Array","isArray","cache","promiseFind","arr","promiseFactory","done","queueNext","reduce","p","shift","useImage","srcList","imgPromise","imagePromiseFactory","useSuspense","useState","setIsLoading","sourceList","sourceKey","join","promise","error","isLoading","undefined"],"mappings":"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"}